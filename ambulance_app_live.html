<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•‘è­·è»Šé¿è®“ (å³æ™‚GPSç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
    }
    .shadow-green-glow {
      box-shadow: 0 0 30px 10px rgba(74, 222, 128, 0.5);
    }
    .shadow-red-glow {
      box-shadow: 0 0 40px 15px rgba(239, 68, 68, 0.6);
    }
    @keyframes pulse-strong {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
    .animate-pulse-strong {
      animation: pulse-strong 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes ping-slow {
      0% { transform: scale(1); opacity: 1; }
      75%, 100% { transform: scale(1.5); opacity: 0; }
    }
    .animate-ping-slow {
      animation: ping-slow 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
    }
    /* è®“ GPS ç‹€æ…‹æ–‡å­—æ›è¡Œ */
    .gps-status {
      font-size: 0.9rem;
      color: #9ca3af; /* text-gray-400 */
      word-break: break-all;
      line-height: 1.4;
    }
  </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">

  <!-- App å®¹å™¨ -->
  <div id="app-container" class="relative flex h-screen w-full flex-col items-center justify-center overflow-hidden bg-gray-900 p-6 font-sans">

    <!-- æ¨¡å¼é¸æ“‡ç•«é¢ (é è¨­é¡¯ç¤º) -->
    <div id="selection-view" class="flex flex-col items-center gap-8 w-full">
      <h1 class="text-3xl font-bold text-center text-blue-300">æ•‘è­·è»Šé¿è®“é€šçŸ¥ç³»çµ±</h1>
      <h2 class="text-xl text-center text-gray-400">(å³æ™‚GPSç‰ˆ)</h2>
      <div class="flex flex-col sm:flex-row gap-6 w-full max-w-md mt-4">
        <!-- é§•é§›æŒ‰éˆ• -->
        <button id="select-driver-btn" class="flex-1 rounded-2xl bg-blue-600 p-8 text-white transition-all hover:bg-blue-500 hover:shadow-2xl hover:-translate-y-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto mb-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 12m-9 0a9 9 0 1 1 18 0 9 9 0 0 1-18 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 12m-2.25 0a2.25 2.25 0 1 1 4.5 0 2.25 2.25 0 0 1-4.5 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 14.25V21" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.41 10.41 5.64 5.64" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.59 10.41 18.36 5.64" />
          </svg>
          <span class="text-2xl font-semibold">æˆ‘æ˜¯é§•é§›</span>
        </button>
        <!-- æ•‘è­·è»ŠæŒ‰éˆ• -->
        <button id="select-ambulance-btn" class="flex-1 rounded-2xl bg-red-600 p-8 text-white transition-all hover:bg-red-500 hover:shadow-2xl hover:-translate-y-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto mb-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
          </svg>
          <span class="text-2xl font-semibold">æˆ‘æ˜¯æ•‘è­·è»Š</span>
        </button>
      </div>
      <div class="mt-4 p-4 rounded-lg bg-gray-800 text-sm text-gray-300 max-w-md">
        <p>ğŸ”´ <span class="font-bold">é‡è¦æç¤ºï¼š</span>é€™æ˜¯ä¸€å€‹ä½¿ç”¨å³æ™‚ GPS çš„åŸå‹ã€‚æ‚¨éœ€è¦**å…©å°æ‰‹æ©Ÿ** (ä¸€å°è¨­ç‚ºæ•‘è­·è»Šï¼Œä¸€å°è¨­ç‚ºé§•é§›) ä¸¦å…è¨± GPS æ¬Šé™æ‰èƒ½é€²è¡Œæ¸¬è©¦ã€‚</p>
        <p id="auth-status" class="text-yellow-400 text-center mt-2">æ­£åœ¨é€£ç·šè‡³ä¼ºæœå™¨...</p>
      </div>
    </div>

    <!-- é§•é§›æ¨¡å¼ç•«é¢ (é è¨­éš±è—) -->
    <div id="driver-view" class="flex flex-col items-center justify-between h-full w-full max-w-md" style="display: none;">
      <!-- æ¨™é¡Œå’Œè¿”å›æŒ‰éˆ• -->
      <div class="w-full flex items-center justify-between pt-4">
        <button class="go-back-btn p-2 rounded-full hover:bg-gray-700 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
          </svg>
        </button>
        <h1 class="text-2xl font-bold text-blue-300">é§•é§›æ¨¡å¼</h1>
        <div class="w-8"></div>
      </div>
      
      <!-- ç‹€æ…‹é¡¯ç¤ºå™¨ -->
      <div class="flex-1 flex items-center justify-center -mt-16">
        <div id="driver-status-display" class="relative flex items-center justify-center w-64 h-64 sm:w-80 sm:h-80 rounded-full transition-all duration-300 bg-green-500 shadow-green-glow">
          <div id="driver-status-content">
            <div class="text-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24 mx-auto mb-4 text-green-200">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              <span class="text-5xl font-extrabold">å®‰å…¨</span>
              <p class="text-lg text-green-200 mt-2">å‘¨åœç„¡ç‹€æ³</p>
            </div>
          </div>
        </div>
      </div>

      <!-- GPS ç‹€æ…‹é¢æ¿ -->
      <div class="w-full pb-6 text-center">
        <h3 class="text-lg text-center text-gray-300 mb-2">å³æ™‚ä½ç½®è³‡è¨Š</h3>
        <div class="bg-gray-800 p-4 rounded-lg text-left">
          <p class="gps-status">æˆ‘çš„ä½ç½®: <span id="driver-my-location" class="text-white">æ­£åœ¨å–å¾—...</span></p>
          <p class="gps-status mt-2">æ•‘è­·è»Šä½ç½®: <span id="driver-ambulance-location" class="text-white">å°šæœªåµæ¸¬åˆ°</span></p>
          <p class="text-xl font-bold text-center mt-3">è·é›¢: <span id="driver-distance" class="text-yellow-400">---</span></p>
        </div>
      </div>
    </div>

    <!-- æ•‘è­·è»Šæ¨¡å¼ç•«é¢ (é è¨­éš±è—) -->
    <div id="ambulance-view" class="flex flex-col items-center justify-between h-full w-full max-w-md" style="display: none;">
      <!-- æ¨™é¡Œå’Œè¿”å›æŒ‰éˆ• -->
      <div class="w-full flex items-center justify-between pt-4">
        <button class="go-back-btn p-2 rounded-full hover:bg-gray-700 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
          </svg>
        </button>
        <h1 class="text-2xl font-bold text-red-300">æ•‘è­·è»Šæ¨¡å¼</h1>
        <div class="w-8"></div>
      </div>
      
      <!-- å»£æ’­æŒ‰éˆ•å’Œç‹€æ…‹ -->
      <div class="flex-1 flex flex-col items-center justify-center -mt-16 gap-6">
        <p class="text-xl text-gray-300">å»£æ’­ç‹€æ…‹ï¼š</p>
        <p id="broadcast-status-text" class="text-3xl font-bold text-gray-500">
          å»£æ’­å·²åœæ­¢
        </p>
        
        <div id="broadcast-icon-container" class="w-64 h-64 rounded-full bg-gray-700 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-32 h-32 text-gray-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
          </svg>
        </div>
      </div>

      <!-- GPS ç‹€æ…‹ -->
      <div class="w-full pb-6 text-center">
        <div class="bg-gray-800 p-4 rounded-lg text-left">
          <p class="gps-status">æˆ‘çš„ä½ç½®: <span id="ambulance-my-location" class="text-white">æ­£åœ¨å–å¾—...</span></p>
        </div>
        <!-- æ–°å¢ï¼šç›®çš„åœ°è¼¸å…¥æ¡† (æ¨¡æ“¬) -->
        <div class="mt-4 text-left">
          <label for="destination" class="block text-sm font-medium text-gray-300 mb-1">è¼¸å…¥ç›®çš„åœ° (æ¨¡æ“¬):</label>
          <input type="text" id="destination" class="w-full rounded-lg p-2 bg-gray-700 text-white border border-gray-600" placeholder="ä¾‹å¦‚ï¼šXXé†«é™¢ (æ­¤åŠŸèƒ½ç‚ºæ¨¡æ“¬)">
        </div>
        <button id="toggle-broadcast-btn" class="w-full mt-4 rounded-lg p-6 text-2xl font-bold text-white transition-colors bg-red-700 hover:bg-red-600">
          é–‹å§‹å»£æ’­
        </button>
      </div>
    </div>

  </div>

  <!-- è¼‰å…¥ Firebase BARE SDK -->
  <script type="module">
    // ---------------------------------------------------
    // è­¦å‘Šï¼šé€™æ˜¯ä¸€å€‹å…¬é–‹çš„ Firebase å¯¦ä¾‹ï¼Œåƒ…ä¾›åŸå‹æ¸¬è©¦ã€‚
    // è«‹å‹¿åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä½¿ç”¨æ­¤é…ç½®ã€‚
    // ---------------------------------------------------
    const firebaseConfig = JSON.parse(atob("eyJhcGlLZXkiOiJBSXphU3lEc2pmejVqOThVOUgxN0JidklLMy1qMUtzcHh3TjFYb2MiLCJhdXRoRG9tYWluIjoiZ2VtaW5pLWFtYnVsYW5jZS1hcHAuZmlyZWJhc2VhcHAuY29tIiwicHJvamVjdElkIjoiZ2VtaW5pLWFtYnVsYW5jZS1hcHAiLCJzdG9yYWdlQnVja2V0IjoiZ2VtaW5pLWFtYnVsYW5jZS1hcHAuYXBwc3BvdC5jb20iLCJtZXNzYWdpbmdTZW5kZXJJZCI6IjY4ODkwNTU1MzYyMSIsImFwcElkIjoiMToxMTEyMzA3NzkzMTU5OndlYjo0ZWE5YTA5YjdlZjNlMGEyMWExMWU0In0="));

    // åŒ¯å…¥ Firebase æ¨¡çµ„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      signInAnonymously, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      deleteDoc, 
      onSnapshot, 
      serverTimestamp,
      setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
      
      // Firebase åˆå§‹åŒ–
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      setLogLevel('error'); // é—œé–‰è©³ç´°æ—¥èªŒ

      let userId = null;
      // é€™è£¡çš„ App ID åƒ…ç”¨æ–¼å€åˆ†ä¸åŒæ¸¬è©¦è€…çš„æ•¸æ“š
      const appId = 'prototype-v1'; 
      let ambulanceDocRef = null;

      // ç‹€æ…‹è®Šæ•¸
      let appMode = 'selection';
      let notification = null;
      let isBroadcasting = false;

      // GPS ç›£è½å™¨ ID
      let driverGpsWatcher = null;
      let ambulanceGpsWatcher = null;
      let ambulanceListener = null; // Firestore ç›£è½å™¨

      // ä½ç½®è®Šæ•¸
      let myDriverLocation = null;
      let ambulanceDbLocation = null;

      // èªéŸ³åˆæˆ
      const synth = window.speechSynthesis;
      let currentUtterance = null;
      const ALERT_DISTANCE_METERS = 500; // 500 å…¬å°ºè­¦å ±

      // ç²å– DOM å…ƒç´ 
      const selectionView = document.getElementById('selection-view');
      const driverView = document.getElementById('driver-view');
      const ambulanceView = document.getElementById('ambulance-view');
      
      const authStatus = document.getElementById('auth-status');
      const selectDriverBtn = document.getElementById('select-driver-btn');
      const selectAmbulanceBtn = document.getElementById('select-ambulance-btn');
      const goBackBtns = document.querySelectorAll('.go-back-btn');

      // é§•é§›æ¨¡å¼å…ƒç´ 
      const driverStatusDisplay = document.getElementById('driver-status-display');
      const driverStatusContent = document.getElementById('driver-status-content');
      const driverMyLocation = document.getElementById('driver-my-location');
      const driverAmbulanceLocation = document.getElementById('driver-ambulance-location');
      const driverDistance = document.getElementById('driver-distance');

      // æ•‘è­·è»Šæ¨¡å¼å…ƒç´ 
      const broadcastStatusText = document.getElementById('broadcast-status-text');
      const broadcastIconContainer = document.getElementById('broadcast-icon-container');
      const toggleBroadcastBtn = document.getElementById('toggle-broadcast-btn');
      const ambulanceMyLocation = document.getElementById('ambulance-my-location');

      // -----------------
      // Firebase èªè­‰
      // -----------------
      signInAnonymously(auth).catch((error) => {
        console.error("åŒ¿åç™»å…¥å¤±æ•—:", error);
        authStatus.textContent = "ä¼ºæœå™¨é€£ç·šå¤±æ•—ã€‚";
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          authStatus.textContent = "ä¼ºæœå™¨é€£ç·šæˆåŠŸï¼";
          // è¨­ç½® Firestore æ–‡æª”åƒç…§
          // ç‚ºäº†è®“æ‰€æœ‰ç”¨æˆ¶éƒ½èƒ½çœ‹åˆ°ï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å€‹å…¬å…±è·¯å¾‘
          ambulanceDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'ambulance', 'live_location');
        } else {
          userId = null;
          authStatus.textContent = "å·²æ–·ç·šã€‚";
        }
      });

      // -----------------
      // ç•«é¢åˆ‡æ›é‚è¼¯
      // -----------------

      function setAppMode(mode) {
        appMode = mode;
        selectionView.style.display = 'none';
        driverView.style.display = 'none';
        ambulanceView.style.display = 'none';

        // åœæ­¢æ‰€æœ‰ GPS å’Œç›£è½å™¨
        stopDriverMode();
        stopAmbulanceMode();

        if (mode === 'selection') {
          selectionView.style.display = 'flex';
          resetAlert(); // è¿”å›æ™‚é‡è¨­è­¦å ±
        } else if (mode === 'driver') {
          driverView.style.display = 'flex';
          startDriverMode(); // å•Ÿå‹•é§•é§›æ¨¡å¼
        } else if (mode === 'ambulance') {
          ambulanceView.style.display = 'flex';
          // æ•‘è­·è»Šæ¨¡å¼ç”±æŒ‰éˆ•å•Ÿå‹•ï¼Œé€™è£¡åªåˆ‡æ›ç•«é¢
          updateAmbulanceGpsUi('æ­£åœ¨å–å¾—...');
        }
      }

      selectDriverBtn.addEventListener('click', () => setAppMode('driver'));
      selectAmbulanceBtn.addEventListener('click', () => setAppMode('ambulance'));

      goBackBtns.forEach(btn => {
        btn.addEventListener('click', () => setAppMode('selection'));
      });

      // -----------------
      // èªéŸ³æ’­æ”¾é‚è¼¯
      // -----------------

      function speak(text) {
        if (!synth) {
          console.error('ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³åˆæˆï¼');
          updateDriverStatus('èªéŸ³åˆæˆå¤±æ•—');
          return;
        }
        if (synth.speaking) synth.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.rate = 1.1;
        utterance.pitch = 1.2;
        utterance.volume = 1;
        utterance.onend = () => { currentUtterance = null; };
        currentUtterance = utterance;
        synth.speak(utterance);
      }
      
      // -----------------
      // é§•é§›æ¨¡å¼é‚è¼¯
      // -----------------

      function startDriverMode() {
        if (!navigator.geolocation) {
          updateDriverGpsUi('ç€è¦½å™¨ä¸æ”¯æŒ GPS');
          return;
        }
        
        // 1. é–‹å§‹ç›£è½è‡ªå·±çš„ GPS
        updateDriverGpsUi('æ­£åœ¨å–å¾—...');
        driverGpsWatcher = navigator.geolocation.watchPosition(
          updateDriverPosition, 
          handleGpsError, 
          { enableHighAccuracy: true }
        );

        // 2. é–‹å§‹ç›£è½ Firebase ä¸Šçš„æ•‘è­·è»Šä½ç½®
        if (ambulanceListener) ambulanceListener(); // ç¢ºä¿èˆŠçš„ç›£è½å™¨å·²ç§»é™¤
        
        ambulanceListener = onSnapshot(ambulanceDocRef, (doc) => {
          if (doc.exists()) {
            const data = doc.data();
            // æª¢æŸ¥æ™‚é–“æˆ³ï¼Œå¦‚æœå¤ªèˆŠ (ä¾‹å¦‚è¶…é30ç§’) å°±ä¸é¡¯ç¤º
            const now = new Date();
            const timestamp = data.timestamp ? data.timestamp.toDate() : new Date(0);
            if ((now - timestamp) < 30000) {
              ambulanceDbLocation = { lat: data.latitude, lon: data.longitude };
              driverAmbulanceLocation.textContent = `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
              checkDistance();
            } else {
              driverAmbulanceLocation.textContent = "è¨Šè™ŸéèˆŠ";
              ambulanceDbLocation = null;
              checkDistance();
            }
          } else {
            driverAmbulanceLocation.textContent = "å°šæœªåµæ¸¬åˆ°";
            ambulanceDbLocation = null;
            checkDistance();
          }
        }, (error) => {
          console.error("ç›£è½æ•‘è­·è»Šä½ç½®å¤±æ•—:", error);
          driverAmbulanceLocation.textContent = "ç›£è½å¤±æ•—";
        });
      }
      
      function stopDriverMode() {
        if (driverGpsWatcher) {
          navigator.geolocation.clearWatch(driverGpsWatcher);
          driverGpsWatcher = null;
        }
        if (ambulanceListener) {
          ambulanceListener(); // åœæ­¢ç›£è½
          ambulanceListener = null;
        }
        myDriverLocation = null;
        ambulanceDbLocation = null;
      }

      function updateDriverPosition(pos) {
        myDriverLocation = { 
          lat: pos.coords.latitude, 
          lon: pos.coords.longitude 
        };
        updateDriverGpsUi(`${myDriverLocation.lat.toFixed(4)}, ${myDriverLocation.lon.toFixed(4)}`);
        checkDistance();
      }

      function updateDriverGpsUi(text) {
        driverMyLocation.textContent = text;
      }

      function handleGpsError(error) {
        let msg = 'GPS éŒ¯èª¤';
        if (error.code === 1) msg = 'GPS å·²è¢«æ‹’çµ•';
        if (error.code === 2) msg = 'ç„¡æ³•å–å¾—ä½ç½®';
        if (error.code === 3) msg = 'GPS è«‹æ±‚è¶…æ™‚';
        updateDriverGpsUi(msg);
        updateAmbulanceGpsUi(msg);
      }

      function checkDistance() {
        if (!myDriverLocation || !ambulanceDbLocation) {
          driverDistance.textContent = "---";
          if (notification) resetAlert(); // å¦‚æœä»»ä¸€ä½ç½®æ¶ˆå¤±ï¼Œè§£é™¤è­¦å ±
          return;
        }

        const dist = haversineDistance(
          myDriverLocation.lat, myDriverLocation.lon,
          ambulanceDbLocation.lat, ambulanceDbLocation.lon
        );
        
        driverDistance.textContent = `${dist.toFixed(0)} å…¬å°º`;

        if (dist < ALERT_DISTANCE_METERS && !notification) {
          // é€²å…¥è­¦å ±ç¯„åœ
          triggerAlert('approach');
        } else if (dist >= ALERT_DISTANCE_METERS && notification) {
          // é›¢é–‹è­¦å ±ç¯„åœ
          resetAlert();
        }
      }

      function updateDriverStatus(newNotification) {
        notification = newNotification;
        if (notification) {
          driverStatusDisplay.classList.remove('bg-green-500', 'shadow-green-glow');
          driverStatusDisplay.classList.add('bg-red-600', 'shadow-red-glow', 'animate-pulse');
          driverStatusContent.innerHTML = `
            <div class="text-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-24 h-24 mx-auto mb-4 animate-ping-slow">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
              </svg>
              <span class="text-4xl font-extrabold">${notification}</span>
            </div>
          `;
        } else {
          driverStatusDisplay.classList.add('bg-green-500', 'shadow-green-glow');
          driverStatusDisplay.classList.remove('bg-red-600', 'shadow-red-glow', 'animate-pulse');
          driverStatusContent.innerHTML = `
            <div class="text-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24 mx-auto mb-4 text-green-200">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              <span class="text-5xl font-extrabold">å®‰å…¨</span>
              <p class="text-lg text-green-200 mt-2">å‘¨åœç„¡ç‹€æ³</p>
            </div>
          `;
        }
      }
      
      function triggerAlert(type) {
        let textToSpeak = '';
        if (type === 'approach') {
          // ä¾ç…§æ‚¨çš„è¦æ±‚ï¼Œæ›´æ–°é€šçŸ¥æ–‡å­—
          textToSpeak = 'æ•‘è­·è»Šä½æ–¼å¾Œæ–¹ï¼Œè«‹é é‚Š';
        }
        
        updateDriverStatus(textToSpeak);
        speak(textToSpeak);
      }

      function resetAlert() {
        updateDriverStatus(null);
        if (currentUtterance) synth.cancel();
      }

      // -----------------
      // æ•‘è­·è»Šæ¨¡å¼é‚è¼¯
      // -----------------

      function toggleBroadcast() {
        isBroadcasting = !isBroadcasting;
        
        if (isBroadcasting) {
          // é–‹å§‹å»£æ’­
          startAmbulanceMode();
          broadcastStatusText.textContent = 'æ­£åœ¨å»£æ’­ä½ç½®';
          broadcastStatusText.classList.remove('text-gray-500');
          broadcastStatusText.classList.add('text-green-400');

          broadcastIconContainer.classList.remove('bg-gray-700');
          broadcastIconContainer.classList.add('bg-red-600', 'animate-pulse-strong');
          broadcastIconContainer.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-32 h-32 text-white">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75v.01" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a3.375 3.375 0 1 1 6.75 0 3.375 3.375 0 0 1-6.75 0Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z" />
            </svg>
          `;
          toggleBroadcastBtn.textContent = 'åœæ­¢å»£æ’­';
          toggleBroadcastBtn.classList.remove('bg-red-700', 'hover:bg-red-600');
          toggleBroadcastBtn.classList.add('bg-gray-600', 'hover:bg-gray-500');

        } else {
          // åœæ­¢å»£æ’­
          stopAmbulanceMode();
          broadcastStatusText.textContent = 'å»£æ’­å·²åœæ­¢';
          broadcastStatusText.classList.add('text-gray-500');
          broadcastStatusText.classList.remove('text-green-400');

          broadcastIconContainer.classList.add('bg-gray-700');
          broadcastIconContainer.classList.remove('bg-red-600', 'animate-pulse-strong');
          broadcastIconContainer.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-32 h-32 text-gray-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
            </svg>
          `;
          toggleBroadcastBtn.textContent = 'é–‹å§‹å»£æ’­';
          toggleBroadcastBtn.classList.add('bg-red-700', 'hover:bg-red-600');
          toggleBroadcastBtn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
        }
      }

      function startAmbulanceMode() {
        if (!navigator.geolocation) {
          updateAmbulanceGpsUi('ç€è¦½å™¨ä¸æ”¯æŒ GPS');
          return;
        }
        updateAmbulanceGpsUi('æ­£åœ¨å–å¾—...');
        ambulanceGpsWatcher = navigator.geolocation.watchPosition(
          updateAmbulancePosition, 
          handleGpsError, 
          { enableHighAccuracy: true }
        );
      }

      function stopAmbulanceMode() {
        if (ambulanceGpsWatcher) {
          navigator.geolocation.clearWatch(ambulanceGpsWatcher);
          ambulanceGpsWatcher = null;
        }
        // å¾è³‡æ–™åº«åˆªé™¤ä½ç½®ï¼Œä»¥å…å…¶ä»–é§•é§›æ”¶åˆ°èˆŠè³‡è¨Š
        if (ambulanceDocRef) {
          deleteDoc(ambulanceDocRef).catch(e => console.warn("åˆªé™¤æ–‡æª”å¤±æ•—:", e));
        }
        updateAmbulanceGpsUi('å»£æ’­å·²åœæ­¢');
        
        // å¦‚æœæŒ‰éˆ•ç‹€æ…‹ä¸ä¸€è‡´ï¼ŒåŒæ­¥å®ƒ
        if (isBroadcasting) {
          toggleBroadcast(); 
        }
      }

      function updateAmbulancePosition(pos) {
        const location = { 
          lat: pos.coords.latitude, 
          lon: pos.coords.longitude 
        };
        updateAmbulanceGpsUi(`${location.lat.toFixed(4)}, ${location.lon.toFixed(4)}`);

        // å°‡ä½ç½®å¯«å…¥ Firebase
        if (ambulanceDocRef) {
          setDoc(ambulanceDocRef, {
            latitude: location.lat,
            longitude: location.lon,
            timestamp: serverTimestamp() // ä½¿ç”¨ä¼ºæœå™¨æ™‚é–“æˆ³
          }).catch(e => {
            console.error("å¯«å…¥ Firestore å¤±æ•—:", e);
            updateAmbulanceGpsUi("å»£æ’­å¤±æ•—");
          });
        }
      }

      function updateAmbulanceGpsUi(text) {
        ambulanceMyLocation.textContent = text;
      }

      toggleBroadcastBtn.addEventListener('click', toggleBroadcast);

      // -----------------
      // è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—è·é›¢
      // -----------------
      function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
        const Ï†1 = lat1 * Math.PI / 180;
        const Ï†2 = lat2 * Math.PI / 180;
        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
        const Î”Î» = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // è·é›¢ (å…¬å°º)
      }

    });
  </script>
</body>
</html>
